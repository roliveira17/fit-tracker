{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "gymrats.daily_log.schema.json",
    "title": "GymRats Daily Log",
    "type": "object",
    "required": [
      "day_id",
      "timezone",
      "day_number",
      "goals",
      "body",
      "sleep",
      "subjective_state",
      "training",
      "nutrition",
      "energy_balance",
      "cgm",
      "summary_flags"
    ],
    "properties": {
      "day_id": {
        "type": "string",
        "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
        "description": "Unique daily key in YYYY-MM-DD."
      },
      "timezone": {
        "type": "string",
        "const": "America/Sao_Paulo"
      },
      "day_number": {
        "type": "integer",
        "minimum": 1
      },
  
      "goals": {
        "type": "object",
        "required": ["program_duration_days", "primary_goal", "cgm_active"],
        "properties": {
          "program_duration_days": { "type": "integer", "minimum": 1 },
          "primary_goal": { "type": "string" },
          "cgm_active": { "type": "boolean" },
          "cgm_notes": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      },
  
      "body": {
        "type": "object",
        "required": ["weight_kg", "body_fat_percent", "lean_mass_kg", "bmr_kcal", "source"],
        "properties": {
          "weight_kg": { "type": "number", "minimum": 0 },
          "body_fat_percent": { "type": "number", "minimum": 0, "maximum": 100 },
          "lean_mass_kg": { "type": "number", "minimum": 0 },
          "fat_mass_kg_est": { "type": ["number", "null"], "minimum": 0 },
          "visceral_fat_rating": { "type": ["number", "null"], "minimum": 0 },
          "bmr_kcal": { "type": "integer", "minimum": 0 },
          "source": { "type": "string" },
          "notes": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      },
  
      "sleep": {
        "type": "object",
        "required": [
          "date_reference",
          "total_sleep_hhmm",
          "awake_hhmm",
          "rem_hhmm",
          "core_hhmm",
          "deep_hhmm",
          "subjective",
          "context",
          "source"
        ],
        "properties": {
          "date_reference": {
            "type": "string",
            "enum": ["night_before_day", "same_day_nap", "night_of_day"]
          },
          "total_sleep_hhmm": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
          "awake_hhmm": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
          "rem_hhmm": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
          "core_hhmm": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
          "deep_hhmm": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
          "subjective": {
            "type": "object",
            "required": ["sleep_quality_1_5", "daytime_sleepiness_1_5"],
            "properties": {
              "sleep_quality_1_5": { "type": "integer", "minimum": 1, "maximum": 5 },
              "daytime_sleepiness_1_5": { "type": "integer", "minimum": 1, "maximum": 5 }
            },
            "additionalProperties": false
          },
          "context": {
            "type": "array",
            "items": { "type": "string" }
          },
          "source": { "type": "string" }
        },
        "additionalProperties": false
      },
  
      "subjective_state": {
        "type": "object",
        "required": ["stress_1_5", "mental_clarity_1_5", "pain_or_injury"],
        "properties": {
          "stress_1_5": { "type": "integer", "minimum": 1, "maximum": 5 },
          "mental_clarity_1_5": { "type": "integer", "minimum": 1, "maximum": 5 },
          "pain_or_injury": {
            "type": "object",
            "required": ["has_pain", "notes"],
            "properties": {
              "has_pain": { "type": "boolean" },
              "notes": { "type": ["string", "null"] }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      },
  
      "training": {
        "type": "object",
        "required": ["cardio_sessions", "strength_sessions", "neat"],
        "properties": {
          "cardio_sessions": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type", "start_time_local", "duration_hhmmss", "source"],
              "properties": {
                "type": { "type": "string" },
                "start_time_local": {
                  "type": ["string", "null"],
                  "pattern": "^\\d{2}:\\d{2}$"
                },
                "duration_hhmmss": { "type": "string", "pattern": "^\\d{2}:\\d{2}:\\d{2}$" },
                "avg_hr_bpm": { "type": ["integer", "null"], "minimum": 0 },
                "max_hr_bpm": { "type": ["integer", "null"], "minimum": 0 },
                "hr_zones": {
                  "type": ["object", "null"],
                  "properties": {
                    "zone_1_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                    "zone_2_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                    "zone_3_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                    "zone_4_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                    "zone_5_percent": { "type": "number", "minimum": 0, "maximum": 100 }
                  },
                  "additionalProperties": false
                },
                "relative_effort": { "type": ["integer", "null"], "minimum": 1, "maximum": 10 },
                "source": { "type": "string" },
                "notes": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          },
  
          "strength_sessions": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type", "start_time_local", "source", "exercises"],
              "properties": {
                "type": { "type": "string" },
                "start_time_local": {
                  "type": ["string", "null"],
                  "pattern": "^\\d{2}:\\d{2}$"
                },
                "source": { "type": "string" },
                "exercises": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["name", "sets"],
                    "properties": {
                      "name": { "type": "string" },
                      "sets": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "required": ["set", "reps"],
                          "properties": {
                            "set": { "type": "integer", "minimum": 1 },
                            "reps": { "type": "integer", "minimum": 0 },
                            "weight_kg": { "type": ["number", "null"], "minimum": 0 },
                            "weight_kg_each": { "type": ["number", "null"], "minimum": 0 },
                            "assistance": { "type": ["string", "null"] }
                          },
                          "additionalProperties": false
                        }
                      }
                    },
                    "additionalProperties": false
                  }
                },
                "notes": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          },
  
          "neat": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type", "source"],
              "properties": {
                "type": { "type": "string" },
                "distance_km": { "type": ["number", "null"], "minimum": 0 },
                "duration_minutes": { "type": ["number", "null"], "minimum": 0 },
                "calories_kcal": { "type": ["number", "null"], "minimum": 0 },
                "source": { "type": "string" },
                "notes": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      },
  
      "nutrition": {
        "type": "object",
        "required": ["caffeine", "meals", "day_totals"],
        "properties": {
          "caffeine": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["time_local", "item", "sugar"],
              "properties": {
                "time_local": { "type": "string", "pattern": "^\\d{2}:\\d{2}$" },
                "item": { "type": "string" },
                "sugar": { "type": "boolean" },
                "notes": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          },
  
          "meals": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["meal_name", "time_local", "items", "meal_totals"],
              "properties": {
                "meal_name": { "type": "string" },
                "time_local": {
                  "type": ["string", "null"],
                  "pattern": "^\\d{2}:\\d{2}$"
                },
                "items": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["food", "kcal", "protein_g", "carbs_g", "fat_g", "fiber_g", "estimated", "estimation_method"],
                    "properties": {
                      "food": { "type": "string" },
                      "amount_g": { "type": ["number", "null"], "minimum": 0 },
                      "amount_ml": { "type": ["number", "null"], "minimum": 0 },
                      "amount_unit": { "type": ["number", "null"], "minimum": 0 },
                      "amount_tbsp": { "type": ["number", "null"], "minimum": 0 },
  
                      "kcal": { "type": "number", "minimum": 0 },
                      "protein_g": { "type": "number", "minimum": 0 },
                      "carbs_g": { "type": "number", "minimum": 0 },
                      "fat_g": { "type": "number", "minimum": 0 },
                      "fiber_g": { "type": "number", "minimum": 0 },
  
                      "estimated": { "type": "boolean" },
                      "estimation_method": {
                        "type": "string",
                        "enum": [
                          "label",
                          "standard_food_table",
                          "brand_average",
                          "label_typical",
                          "rough_estimate",
                          "standard_nutrition_reference"
                        ]
                      },
                      "label_basis": { "type": ["string", "null"] },
                      "notes": { "type": ["string", "null"] }
                    },
                    "additionalProperties": false
                  }
                },
                "meal_totals": {
                  "type": "object",
                  "required": ["kcal", "protein_g", "carbs_g", "fat_g", "fiber_g"],
                  "properties": {
                    "kcal": { "type": "number", "minimum": 0 },
                    "protein_g": { "type": "number", "minimum": 0 },
                    "carbs_g": { "type": "number", "minimum": 0 },
                    "fat_g": { "type": "number", "minimum": 0 },
                    "fiber_g": { "type": "number", "minimum": 0 }
                  },
                  "additionalProperties": false
                }
              },
              "additionalProperties": false
            }
          },
  
          "day_totals": {
            "type": "object",
            "required": ["kcal", "protein_g", "carbs_g", "fat_g", "fiber_g"],
            "properties": {
              "kcal": { "type": "number", "minimum": 0 },
              "protein_g": { "type": "number", "minimum": 0 },
              "carbs_g": { "type": "number", "minimum": 0 },
              "fat_g": { "type": "number", "minimum": 0 },
              "fiber_g": { "type": "number", "minimum": 0 }
            },
            "additionalProperties": false
          },
  
          "notes": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      },
  
      "energy_balance": {
        "type": "object",
        "required": ["bmr_kcal", "tdee_estimated_kcal", "intake_kcal", "deficit_kcal_est", "confidence"],
        "properties": {
          "bmr_kcal": { "type": "integer", "minimum": 0 },
          "tdee_estimated_kcal": { "type": "integer", "minimum": 0 },
          "intake_kcal": { "type": "number", "minimum": 0 },
          "deficit_kcal_est": { "type": "number" },
          "confidence": { "type": "string", "enum": ["low", "medium", "high"] },
          "notes": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      },
  
      "cgm": {
        "description": "CGM can be null when unavailable.",
        "type": ["object", "null"]
      },
  
      "summary_flags": {
        "type": "object",
        "required": ["has_cgm_data", "sleep_outlier_contextual", "training_completed", "nutrition_completed"],
        "properties": {
          "has_cgm_data": { "type": "boolean" },
          "sleep_outlier_contextual": { "type": "boolean" },
          "training_completed": { "type": "boolean" },
          "nutrition_completed": { "type": "boolean" },
          "notes": { "type": ["string", "null"] }
        },
        "additionalProperties": false
      }
    },
    "additionalProperties": false
  }
  